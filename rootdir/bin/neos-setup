#!/system/bin/sh

log="/data/.neos-setup"

# mount
SLOT_SUFFIX="$(getprop ro.boot.slot_suffix)"

blockdev --setrw /dev/block/by-name/system${SLOT_SUFFIX}
mount -o remount,rw -t auto / || mount -o remount,rw -t auto /system
mount -o remount,rw /data

# neos-ssh keys
DSA_KEY=/data/data/com.termux/files/usr/etc/ssh/ssh_host_dsa_key
DSA_PUB_KEY=/data/data/com.termux/files/usr/etc/ssh/ssh_host_dsa_key.pub
RSA_KEY=/data/data/com.termux/files/usr/etc/ssh/ssh_host_rsa_key
RSA_PUB_KEY=/data/data/com.termux/files/usr/etc/ssh/ssh_host_rsa_key.pub

rm -f $log
echo "neos-setup log" >> $log

(
cd /data/data/com.termux/files

if [ ! -d /data/data/com.termux/files/usr ]; then
    # bootstrap
    mkdir usr
    mkdir home
    unzip -d usr /system/etc/termux-bootstrap.zip
    # comma home
    unzip -d home /system/etc/termux-home.zip

    mkdir -p cache/apt/archives/partial

    cd usr
    # symlinks
    cat SYMLINKS.txt | while read -r line; do
        dest=$(echo "$line" | awk -F '←' '{ print $1 }')
        link=$(echo "$line" | awk -F '←' '{ print $2 }')
        echo "Creating symlink: $link --> $dest"
        ln -s "$dest" "$link"
    done
    rm -f SYMLINKS.txt

    # perms
    find bin lib/apt lib/bash libexec -type f -exec chmod 700 "{}" \;
    for p in ./share/doc/util-linux/getopt/getopt-prase.bash \
    	./share/doc/util-linux/getopt/getopt-parse.tcsh \
	    ./var/service/ftpd/run ./var/service/telnetd/run; do
        if [ -f "$p" ]; then
            chmod 700 "$p"
        fi
    done

    # neos-ssh keys
    mkdir -p etc/ssh
    cd etc/ssh

    # comma keys or leave em
    if [ ! -f $DSA_KEY ]; then
        if [ -f /system/etc/ssh/ssh_host_dsa_key ]; then
            cp -f /system/etc/ssh/ssh_host_dsa_key $DSA_KEY
            cp -f /system/etc/ssh/ssh_host_dsa_key.pub $DSA_PUB_KEY
        fi
        chmod 600 /$DSA_KEY
        chmod 644 $DSA_PUB_KEY
    fi

    if [ ! -f $RSA_KEY ]; then
        if [ -f /system/etc/ssh/ssh_host_rsa_key ]; then
            cp -f /system/etc/ssh/ssh_host_rsa_key $RSA_KEY
            cp -f /system/etc/ssh/ssh_host_rsa_key.pub $RSA_PUB_KEY
        fi
        chmod 600 /$RSA_KEY
        chmod 644 $RSA_PUB_KEY
    fi 
fi

if [ ! -d /system/comma/ ]; then
    mkdir -p /system/comma/
fi

if [ -f /data/data/com.termux/files/usr/libexec/termux/command-not-found ]; then
    setprop neos.termux_ready 1
    # for comma compatibility
    ln -sf /data/data/com.termux/files/usr /system/comma/usr
    ln -sf /data/data/com.termux/files/home /system/comma/home
fi
) 2>&1 | tee -a ./$log;

# unmount
blockdev --setro /dev/block/by-name/system${SLOT_SUFFIX}
mount -o remount,ro -t auto / || mount -o remount,ro -t auto /system
mount -o remount,rw /data